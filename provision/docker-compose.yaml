version: '3'
services:
  golr:
    hostname: golr 
    container_name: golr 
    image: amigo:{{ tag }}
    environment:
      - GOLR=1
      - AMIGO=0
    volumes:
      - {{ repo_dir }}:/srv/amigo
      - {{ stage_dir }}/srv-solr-data:/srv/solr/data
      - {{ stage_dir }}/amigo.yaml:/srv/amigo/conf/amigo.yaml
    restart: unless-stopped

  amigo:
    hostname: amigo
    container_name: amigo
    image: amigo:{{ tag }}
    environment:
      - GOLR=0
      - AMIGO=1
    volumes:
      - {{ repo_dir }}:/srv/amigo
      - {{ stage_dir }}/amigo_working_path:/tmp
      - {{ stage_dir }}/golr_timestamp.log:/tmp/golr_timestamp.log
      - {{ stage_dir }}/release-archive-doi.json:/tmp/release-archive-doi.json
      - {{ stage_dir }}/srv-solr-data:/srv/solr/data
      - {{ stage_dir }}/amigo.yaml:/srv/amigo/conf/amigo.yaml
      - {{ stage_dir }}/001-inline-amigo.conf:/etc/apache2/sites-available/001-inline-amigo.conf
      - {{ stage_dir }}/apache2.ports.conf:/etc/apache2/ports.conf
      - {{ stage_dir }}/apache_amigo_logs:/var/log/apache2
    restart: unless-stopped
    depends_on:
      - golr 

  apache_amigo:
    hostname: apache_amigo
    container_name: apache_amigo
    image: go-apache:{{ tag }}
    restart: unless-stopped
    environment:
      - USE_S3={{ USE_S3 }}
    volumes:
      - {{ stage_dir }}/httpd-vhosts-amigo.conf:/etc/apache2/sites-enabled/httpd-vhosts-amigo.conf
      - {{ stage_dir }}/httpd-vhosts-golr.conf:/etc/apache2/sites-enabled/httpd-vhosts-golr.conf
      - {{ stage_dir }}/apache_proxy_logs:/var/log/apache2
      - {{ stage_dir }}/logrotate-to-s3.sh:/opt/bin/logrotate-to-s3.sh
      - {{ stage_dir }}/apache2:/etc/logrotate.d/apache2
      - {{ stage_dir }}/s3cfg:/opt/credentials/s3cfg
    ports:
      - "80:80"
    depends_on:
      - golr 
      - amigo
